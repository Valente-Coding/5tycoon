local vehicleLocations = {
    {
        coords = vector4(-44.3891, -1100.7106, 27.3023, 168.1030),
        buyVehCoords = vector4(-23.6386, -1094.5032, 26.6680, 339.3859),
        vehicles = {
            {model = "comet6", price = 150000, spawnCoords = vector4(-47.5742, -1092.0851, 26.7250, 90.7406)},
            {model = "deity", price = 150000, spawnCoords = vector4(-37.4381, -1093.3636, 26.6837, 24.3173)},
            {model = "turismo2", price = 150000, spawnCoords = vector4(-42.3216, -1101.3484, 26.5996, 202.7966)},
            {model = "torero2", price = 150000, spawnCoords = vector4(-54.5700, -1097.1466, 26.6648, 36.5422)},
            {model = "cypher", price = 150000, spawnCoords = vector4(-50.0374, -1083.8835, 26.7209, 248.1748)}
        }
    },
    {
        coords = vector4(-1261.0756, -361.7855, 36.9076, 323.9908),
        buyVehCoords = vector4(-1224.4170, -348.5058, 36.7057, 118.6624),
        vehicles = {
            {model = "sc1", price = 150000, spawnCoords = vector4(-1234.3430, -355.2694, 36.9657, 118.4086)},
            {model = "schlagen", price = 150000, spawnCoords = vector4(-1269.5414, -364.3029, 36.4759, 348.1712)},
            {model = "sm722", price = 150000, spawnCoords = vector4(-1270.8866, -358.6362, 36.5220, 252.5311)},
            {model = "jugular", price = 150000, spawnCoords = vector4(-1266.7131, -355.1023, 36.6212, 156.8050)},
            {model = "italirsx", price = 150000, spawnCoords = vector4(-1256.2686, -366.7053, 36.5240, 119.0064)},
            {model = "vstr", price = 150000, spawnCoords = vector4(-1231.6013, -347.1530, 36.7516, 84.8176)},
            {model = "mamba", price = 150000, spawnCoords = vector4(-1232.5981, -344.3934, 36.6237, 84.5981)},
            {model = "jester4", price = 150000, spawnCoords = vector4(-1262.9005, -353.0871, 36.5500, 159.8858)}
        }
    },
    {
        coords = vector4(-162.0785, -1170.4366, 23.0439, 0.4744),
        buyVehCoords = vector4(-239.4139, -1183.9579, 22.4069, 271.0032),
        vehicles = {
            {model = "bobcatxl", price = 150000, spawnCoords = vector4(-183.8735, -1174.4535, 22.8161, 200.2589)},
            {model = "caracara2", price = 150000, spawnCoords = vector4(-187.4485, -1174.4419, 22.7557, 201.1267)},
            {model = "chino", price = 150000, spawnCoords = vector4(-191.2062, -1173.9224, 22.5504, 198.6254)},
            {model = "dominator", price = 150000, spawnCoords = vector4(-194.5041, -1174.2670, 22.3339, 201.3005)},
            {model = "dominator8", price = 150000, spawnCoords = vector4(-198.1103, -1174.0259, 22.5818, 201.1661)},
            {model = "dominator3", price = 150000, spawnCoords = vector4(-132.7579, -1182.2493, 23.1985, 89.2911)},
            {model = "fmj", price = 150000, spawnCoords = vector4(-132.7255, -1178.5524, 23.1522, 89.9427)},
            {model = "retinue2", price = 150000, spawnCoords = vector4(-132.8439, -1175.0988, 23.1611, 90.4346)},
            {model = "hustler", price = 150000, spawnCoords = vector4(-132.8413, -1170.0684, 23.1250, 90.2164)},
            {model = "huntley", price = 150000, spawnCoords = vector4(-132.5133, -1166.6763, 23.1110, 91.1502)},
            {model = "hotknife", price = 150000, spawnCoords = vector4(-139.0159, -1162.4037, 23.0873, 180.8218)},
            {model = "gb200", price = 150000, spawnCoords = vector4(-144.1555, -1162.3588, 23.0167, 180.6370)},
            {model = "emerus", price = 150000, spawnCoords = vector4(-151.7991, -1166.4474, 23.0631, 270.5679)},
            {model = "t20", price = 150000, spawnCoords = vector4(-152.1866, -1170.0413, 23.3449, 269.4490)},
            {model = "flashgt", price = 150000, spawnCoords = vector4(-147.6172, -1162.4351, 23.5649, 181.0142)}
        }
    },
    {
        coords = vector4(1225.4297, 2709.3545, 38.0058, 332.5589),
        buyVehCoords = vector4(1199.4268, 2726.9011, 37.3679, 262.5827),
        vehicles = {
            {model = "gp1", price = 150000, spawnCoords = vector4(1238.3577, 2698.5774, 37.3880, 32.7099)},
            {model = "locust", price = 150000, spawnCoords = vector4(1232.9938, 2698.4314, 37.4296, 33.1491)},
            {model = "penetrator", price = 150000, spawnCoords = vector4(1226.3961, 2697.7588, 37.2928, 34.9226)},
            {model = "rhinehart", price = 150000, spawnCoords = vector4(1219.3116, 2697.5757, 37.7466, 33.2378)},
            {model = "revolter", price = 150000, spawnCoords = vector4(1220.4451, 2708.1797, 37.5136, 272.8931)},
            {model = "entityxf", price = 150000, spawnCoords = vector4(1228.6248, 2708.5330, 37.4072, 182.3869)},
            {model = "infernus2", price = 150000, spawnCoords = vector4(1234.7684, 2708.6638, 37.5308, 91.0315)},
            {model = "sultan", price = 150000, spawnCoords = vector4(1227.8799, 2718.9260, 37.3985, 180.2785)},
            {model = "elegy", price = 150000, spawnCoords = vector4(1221.9530, 2719.4041, 37.3304, 178.5236)},
            {model = "sentinel4", price = 150000, spawnCoords = vector4(1233.3958, 2719.3184, 37.4361, 182.0307)}
        }
    }
}

local spawnvehs = {}

Citizen.CreateThread(function()
    local blips = {}

    for _, location in ipairs(vehicleLocations) do
        local blip = AddBlipForCoord(location.coords.x, location.coords.y, location.coords.z + 1.0)
        SetBlipSprite(blip, 225)
        SetBlipScale(blip, 0.7)
        SetBlipColour(blip, 3)
        SetBlipAsShortRange(blip, true)
        BeginTextCommandSetBlipName("STRING")
        AddTextComponentString("Car Dealership")
        EndTextCommandSetBlipName(blip)
        table.insert(blips, blip)

        for _, vehicleInfo in ipairs(location.vehicles) do
            local heading = location.coords.w
            local vehicleHash = GetHashKey(vehicleInfo.model)

            RequestModel(vehicleHash)
            while not HasModelLoaded(vehicleHash) do
                Citizen.Wait(0)
            end

            local spawnedVehicle = CreateVehicle(vehicleHash, vehicleInfo.spawnCoords.x, vehicleInfo.spawnCoords.y, vehicleInfo.spawnCoords.z, vehicleInfo.spawnCoords.w, false, true)
            table.insert(spawnvehs, {veh = spawnedVehicle, price = vehicleInfo.price, spawn = location.buyVehCoords})
        end
    end
end)

Citizen.CreateThread(function()
    while true do
        local playerPed = GetPlayerPed(-1)
        local coords = GetEntityCoords(playerPed)

        for _, location in ipairs(vehicleLocations) do
            if #(coords - vector3(location.coords.x, location.coords.y, location.coords.z)) < 100 then
                ClearAreaOfVehicles(location.coords.x, location.coords.y, location.coords.z, 30.0, false, false, false, false, false)
            end
        end
        Citizen.Wait(30000)
    end
end)

local displayMenu = false

Citizen.CreateThread(function()
    while true do
        Citizen.Wait(1)
        local playerPed = GetPlayerPed(-1)
        local coords = GetEntityCoords(playerPed)
        local closestVeh = nil
        local closestVehDist = nil
        local closestVehPrice = nil
        local closestVehSpawn = nil
        for _, vehData in pairs(spawnvehs) do
            if GetVehiclePedIsTryingToEnter(playerPed) == vehData.veh then
                ClearPedTasksImmediately(playerPed)
            end

            local vehCoords = GetEntityCoords(vehData.veh)
            if closestVehDist ~= nil and #(vehCoords - coords) < 2.0 and #(vehCoords - coords) < closestVehDist then
                closestVeh = vehData.veh
                closestVehDist = vehCoords
                closestVehPrice = vehData.price
                closestVehSpawn = vehData.spawn
            elseif closestVehDist == nil and #(vehCoords - coords) < 2.0 then
                closestVeh = vehData.veh
                closestVehDist = vehCoords
                closestVehPrice = vehData.price
                closestVehSpawn = vehData.spawn
            end
        end

        if closestVeh ~= nil then
            local closestVehCoords = GetEntityCoords(closestVeh)
            DrawMarker(20, closestVehCoords.x, closestVehCoords.y, closestVehCoords.z + 2.0, 0.0, 0.0, 0.0, 0.0, 180.0, 0.0, 1.0, 1.0, 1.0, 255, 0, 0, 255, true, false, false, true, false, false, false)
            if displayMenu == false then
                displayMenu = true
                TriggerEvent("side-menu:addOptions", {
                    {id = "dealership_price", label = "Price:", quantity = "$"..closestVehPrice},
                    {id = "dealership_buy", label = "Buy", cb = function()
                        TriggerEvent("bank:changeBank", -closestVehPrice, function(removed)
                            if removed == true then
                                local newVeh = CreateVehicle(GetEntityModel(closestVeh), closestVehSpawn.x, closestVehSpawn.y, closestVehSpawn.z, closestVehSpawn.w, true, true)
                                TaskWarpPedIntoVehicle(playerPed, newVeh, -1)
                            end
                        end)
                    end}})    
            end
        else
            if displayMenu == true then
                displayMenu = false
                TriggerEvent("side-menu:removeOptions", {{id = "dealership_price"}, {id = "dealership_buy"}})
            end
        end
    end
end)