local houseSaleBlips = {
    {coords = vector3(997.0684, -729.3065, 57.8157), price = 60000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(970.8563, -701.0776, 58.4820), price = 80000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(943.5446, -653.5113, 58.4287), price = 70000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(886.7933, -608.1030, 58.4451), price = 70000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(844.1935, -562.9882, 57.8339), price = 75000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(315.9535, 501.3657, 153.1798), price = 250000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(119.3956, 494.2162, 147.3429), price = 180000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-230.4202, 488.3306, 128.7680), price = 200000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-312.1780, 474.7194, 111.8241), price = 350000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-355.5244, 469.8810, 112.4893), price = 500000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-297.9718, 380.2416, 112.0956), price = 260000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-371.8848, 343.7934, 109.9427), price = 300000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-520.5744, 594.1549, 120.8365), price = 250000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-339.9535, 625.8067, 171.3567), price = 700000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-700.7934, 647.3782, 155.1753), price = 1100000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-1496.0587, 437.2909, 112.4979), price = 450000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-1667.2349, -441.5058, 40.3557), price = 650000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-1490.5225, -658.6225, 29.0251), price = 10000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-1459.0474, -659.1971, 29.5830), price = 10000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(279.8749, -1993.6436, 20.8038), price = 30000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(291.3394, -1980.5107, 21.6005), price = 25000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(324.0533, -1937.4679, 25.0190), price = 45000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(398.4351, -1789.3022, 29.1593), price = 15000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(332.8919, -1741.0638, 29.7306), price = 45000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-14.1733, -1441.8700, 31.1015), price = 50000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-216.5681, -1674.2344, 34.4632), price = 12000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-33.9881, -1847.2666, 26.1936), price = 30000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(130.4368, -1853.6016, 25.2348), price = 25000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(222.9197, -1702.7635, 29.6950), price = 25000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(151.5635, -72.6534, 71.8602), price = 20000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(5.8142, -9.2191, 70.1162), price = 35000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(930.7355, -245.1552, 69.0028), price = 40000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(1258.9746, -1761.5757, 49.6583), price = 30000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(1230.7291, -1590.9597, 53.7661), price = 35000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-830.6603, 115.0213, 55.8298), price = 650000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-998.0771, 157.7113, 62.3191), price = 550000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-902.5498, 191.4798, 69.4461), price = 750000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-1570.6803, 22.7236, 59.5539), price = 550000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-1467.4543, 35.1820, 54.5448), price = 750000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}},
    {coords = vector3(-929.8655, 18.8081, 48.1326), price = 560000, bought = false, selling = false, renting = false, owner = nil, blip = nil, inventory = {}}
}

local clientModels = {
    "a_f_m_bevhills_02",
    "a_f_m_bevhills_01",
    "a_f_m_bodybuild_01",
    "a_f_m_business_02",
    "a_f_m_downtown_01",
    "a_f_m_eastsa_01",
    "a_f_m_eastsa_02",
    "a_f_m_fatbla_01",
    "a_f_m_fatcult_01",
    "a_f_m_fatwhite_01",
    "a_f_m_ktown_01",
    "a_f_m_ktown_02",
    "a_f_m_prolhost_01",
    "a_f_m_salton_01",
    "a_f_m_skidrow_01",
    "a_f_m_soucent_01",
    "a_f_m_soucent_02",
    "a_f_m_soucentmc_01",
    "a_f_m_tourist_01",
    "a_f_m_tramp_01",
    "a_f_m_trampbeac_01",
    "a_f_o_genstreet_01",
    "a_f_o_indian_01",
    "a_f_o_ktown_01",
    "a_f_o_salton_01",
    "a_f_o_soucent_01",
    "a_f_o_soucent_02",
    "a_f_y_beach_01",
    "a_f_y_bevhills_01",
    "a_f_y_bevhills_02",
    "a_f_y_bevhills_03",
    "a_f_y_bevhills_04",
    "a_f_y_business_01",
    "a_f_y_business_02",
    "a_f_y_business_03",
    "a_f_y_business_04",
    "a_f_y_eastsa_01",
    "a_f_y_eastsa_02",
    "a_f_y_eastsa_03",
    "a_f_y_epsilon_01",
    "a_f_y_fitness_01",
    "a_f_y_fitness_02",
    "a_f_y_genhot_01",
    "a_f_y_golfer_01",
    "a_f_y_hiker_01",
    "a_f_y_hippie_01",
    "a_f_y_hipster_01",
    "a_f_y_hipster_02",
    "a_f_y_hipster_03",
    "a_f_y_hipster_04",
    "a_f_y_indian_01",
    "a_f_y_juggalo_01",
    "a_f_y_runner_01",
    "a_f_y_rurmeth_01",
    "a_f_y_scdressy_01",
    "a_f_y_skater_01",
    "a_f_y_soucent_01",
    "a_f_y_soucent_02",
    "a_f_y_soucent_03",
    "a_f_y_tennis_01",
    "a_f_y_topless_01",
    "a_f_y_tourist_01",
    "a_f_y_tourist_02",
    "a_f_y_vinewood_01",
    "a_f_y_vinewood_02",
    "a_f_y_vinewood_03",
    "a_f_y_vinewood_04",
    "a_f_y_yoga_01",
    "a_m_m_acult_01",
    "a_m_m_afriamer_01",
    "a_m_m_beach_01",
    "a_m_m_beach_02",
    "a_m_m_bevhills_01",
    "a_m_m_bevhills_02",
    "a_m_m_business_01",
    "a_m_m_eastsa_01",
    "a_m_m_eastsa_02",
    "a_m_m_farmer_01",
    "a_m_m_fatlatin_01",
    "a_m_m_genfat_01",
    "a_m_m_genfat_02",
    "a_m_m_golfer_01",
    "a_m_m_hasjew_01",
    "a_m_m_hillbilly_01",
    "a_m_m_hillbilly_02",
    "a_m_m_indian_01",
    "a_m_m_ktown_01",
    "a_m_m_malibu_01",
    "a_m_m_mexcntry_01",
    "a_m_m_mexlabor_01",
    "a_m_m_og_boss_01",
    "a_m_m_paparazzi_01",
    "a_m_m_polynesian_01",
    "a_m_m_prolhost_01",
    "a_m_m_rurmeth_01",
    "a_m_m_salton_01",
    "a_m_m_salton_02",
    "a_m_m_salton_03",
    "a_m_m_salton_04",
    "a_m_m_skater_01",
    "a_m_m_skidrow_01",
    "a_m_m_socenlat_01",
    "a_m_m_soucent_01",
    "a_m_m_soucent_02",
    "a_m_m_soucent_03",
    "a_m_m_soucent_04",
    "a_m_m_stlat_02",
    "a_m_m_tennis_01",
    "a_m_m_tourist_01",
    "a_m_m_tramp_01",
    "a_m_m_trampbeac_01",
    "a_m_m_tranvest_01",
    "a_m_m_tranvest_02",
    "a_m_o_acult_01",
    "a_m_o_acult_02",
    "a_m_o_beach_01",
    "a_m_o_genstreet_01",
    "a_m_o_ktown_01",
    "a_m_o_salton_01",
    "a_m_o_soucent_01",
    "a_m_o_soucent_02",
    "a_m_o_soucent_03",
    "a_m_o_tramp_01",
    "a_m_y_acult_01",
    "a_m_y_acult_02",
    "a_m_y_beach_01",
    "a_m_y_beach_02",
    "a_m_y_beach_03",
    "a_m_y_beachvesp_01",
    "a_m_y_beachvesp_02",
    "a_m_y_bevhills_01",
    "a_m_y_bevhills_02",
    "a_m_y_breakdance_01",
    "a_m_y_busicas_01",
    "a_m_y_business_01",
    "a_m_y_business_02",
    "a_m_y_business_03",
    "a_m_y_cyclist_01",
    "a_m_y_dhill_01",
    "a_m_y_downtown_01",
    "a_m_y_eastsa_01",
    "a_m_y_eastsa_02",
    "a_m_y_epsilon_01",
    "a_m_y_epsilon_02",
    "a_m_y_gay_01",
    "a_m_y_gay_02",
    "a_m_y_genstreet_01",
    "a_m_y_genstreet_02",
    "a_m_y_golfer_01",
    "a_m_y_hasjew_01",
    "a_m_y_hiker_01",
    "a_m_y_hippy_01",
    "a_m_y_hipster_01",
    "a_m_y_hipster_02",
    "a_m_y_hipster_03",
    "a_m_y_indian_01",
    "a_m_y_jetski_01",
    "a_m_y_juggalo_01",
    "a_m_y_ktown_01",
    "a_m_y_ktown_02",
    "a_m_y_latino_01",
    "a_m_y_methhead_01",
    "a_m_y_mexthug_01",
    "a_m_y_motox_01",
    "a_m_y_motox_02",
    "a_m_y_musclbeac_01",
    "a_m_y_musclbeac_02",
    "a_m_y_polynesian_01",
    "a_m_y_roadcyc_01",
    "a_m_y_runner_01",
    "a_m_y_runner_02",
    "a_m_y_salton_01",
    "a_m_y_skater_01",
    "a_m_y_skater_02",
    "a_m_y_soucent_01",
    "a_m_y_soucent_02",
    "a_m_y_soucent_03",
    "a_m_y_soucent_04",
    "a_m_y_stbla_01",
    "a_m_y_stbla_02",
    "a_m_y_stlat_01",
    "a_m_y_stwhi_01",
    "a_m_y_stwhi_02",
    "a_m_y_sunbathe_01",
    "a_m_y_surfer_01",
    "a_m_y_vindouche_01",
    "a_m_y_vinewood_01",
    "a_m_y_vinewood_02",
    "a_m_y_vinewood_03",
    "a_m_y_vinewood_04",
    "a_m_y_yoga_01",
}

Citizen.CreateThread(function()
    --TriggerServerEvent("save-load:saveData", "./housing/houses.json", houseSaleBlips)
    TriggerServerEvent("save-load:loadData", "./housing/houses.json", GetPlayerServerId(PlayerId()))
end)


local clientPed = nil
local offeredPrice = nil
local houses = {}
local charID = nil
RegisterNetEvent("save-load:loadDataResult")
AddEventHandler("save-load:loadDataResult", function(data, path)
    if path == "./housing/houses.json" then 
        TriggerEvent("save-load:setGlobalVariables", {{name = "HOUSES_DATA", type = "string", value = json.encode(data)}}) 
        houses = data
        ShowBlips()
    end
end)

local blips = {}

function ShowBlips()
    for _, blip in pairs(blips) do 
        TriggerEvent("waypointer:remove", blip)
    end

    for i, house in pairs(houses) do
        local blipColor = 0
        local blipLabel = ""

        if house.bought then 
            if charID and house.owner == charID then
                if house.renting then 
                    blipColor = 5
                    blipLabel = "Renting House"
                elseif house.selling then
                    blipColor = 3
                    blipLabel = "Selling House"
                else
                    blipColor = 2
                    blipLabel = "House"
                end
            else
                blipColor = 1
                blipLabel = "House Bought"
            end
        else
            blipColor = 0
            blipLabel = "House For Sale"
        end

        table.insert(blips, "house-"..i)
        TriggerEvent("waypointer:add", 
            "house-"..i, --waypointer name
            {
                coords = house.coords, 
                entity = nil, -- No need to set coords when using entities
                sprite = 40, scale = 0.7, 
                short = true, 
                color = blipColor, 
                label = blipLabel
            }, 
            {
                coords = house.coords, 
                color = blipColor, 
                onFoot = true, 
                radarThick = 16, 
                mapThick = 16, 
                range = 30, 
                removeBlip = false
            }
        )
    end
end


local menuOpen = false
local isSellingAHouse = false
local housesOwnTemp = 0
local housesOwn = 0
local closestHouse = nil
Citizen.CreateThread(function()
    local ped = nil 
    local coords = nil
    while true do
        Citizen.Wait(1)

        ped = GetPlayerPed(-1)
        coords = GetEntityCoords(ped)

        if housesOwn ~= housesOwnTemp then 
            housesOwn = housesOwnTemp
        end
        housesOwnTemp = 0
        
        for houseID, house in pairs(houses) do
            if house.selling then 
                isSellingAHouse = true
            end

            if #(vector3(house.coords.x, house.coords.y, house.coords.z) - coords) < 1.2 then 
                closestHouse = house
                if house.bought then 
                    if house.owner and charID and house.owner == charID then 
                        housesOwnTemp = housesOwnTemp + 1
                        if house.selling then 
                            if offeredPrice then 
                                if menuOpen == false then
                                    menuOpen = true
                                    TriggerEvent("side-menu:addOptions", {
                                        {id = "HOUSING_OFFER_PRICE", label = "Offer:", quantity = "$"..offeredPrice},
                                        {id = "HOUSING_OFFER_ACCEPT", label = "Accept Offer", cb = function()
                                            RespondOffer(houseID, true)
                                        end},
                                        {id = "HOUSING_OFFER_REJECT", label = "Reject Offer", cb = function()
                                            RespondOffer(houseID, false)
                                        end},
                                    })
                                end
                            else
                                if menuOpen == false then
                                    menuOpen = true
                                    TriggerEvent("side-menu:addOptions", {
                                        {id = "HOUSING_STOP_SELLING", label = "Stop Selling", cb = function()
                                            StopSelling(houseID)
                                        end},
                                    })
    
                                    if clientPed then 
                                        TriggerEvent("side-menu:addOptions", {
                                            {id = "HOUSING_VISIT", label = "Start Visit", cb = function()
                                                StartVisit(house.price)
                                            end},
                                        })
                                    end
                                end
                            end
                        elseif house.renting then
                            if menuOpen == false then
                                menuOpen = true
                                TriggerEvent("side-menu:addOptions", {
                                    {id = "HOUSING_STOP_RENTING", label = "Stop Renting", cb = function()
                                        StopRenting(houseID)
                                    end},
                                })
                            end
                        else
                            if menuOpen == false then
                                menuOpen = true
                                TriggerEvent("side-menu:addOptions", {
                                    {id = "HOUSING_INV", label = "Inventory", cb = function()
                                        LoadItems(house.inventory)
                                    end}, 
                                    {id = "HOUSING_RENT", label = "Rent", cb = function()
                                        RentHouse(houseID)
                                    end},
                                })

                                if not isSellingAHouse then 
                                    TriggerEvent("side-menu:addOptions", { 
                                        {id = "HOUSING_SELL", label = "Sell", cb = function()
                                            StartSelling(houseID)
                                        end}
                                    })
                                end
                            end
                        end
                    else

                    end
                else
                    if menuOpen == false then
                        menuOpen = true
                        TriggerEvent("side-menu:addOptions", {
                            {id = "HOUSING_PRICE", label = "Price:", quantity = "$"..house.price}, 
                            {id = "HOUSING_BUY", label = "Buy", cb = function()
                                BuyHouse(houseID)
                            end}
                        })
                    end
                end
            elseif closestHouse and closestHouse == house and #(vector3(house.coords.x, house.coords.y, house.coords.z) - coords) >= 1.2 then
                if menuOpen then
                    menuOpen = false
                    closestHouse = nil
                    CloseAllMenus()
                end
            end
        end
    end
end)   

function BuyHouse(houseID)
    TriggerEvent("bank:changeBank", -houses[houseID].price, function(check, needAmount)
        if check then 
            houses[houseID].bought = true
            houses[houseID].owner = GetExternalKvpInt("save-load", "CHAR_ID")
            
            SaveHousingData()
            CloseAllMenus()
            TriggerEvent("notification:send", {color = "green", time = 7000, text = "Thank you for signing the contract. You are now the owner of this property"})
        else
            TriggerEvent("notification:send", {color = "red", time = 7000, text = "You don't have enought money to purchase this house. You need at least $"..needAmount})
        end
    end)
end

function StartSelling(houseID) 
    houses[houseID].selling = true
    isSellingAHouse = true

    TriggerEvent("notification:send", {color = "blue", time = 7000, text = "You posted your house in a Real Estate website. You will be contacted when a buyer is interested in it."})

    SearchForClients(houseID)

    SaveHousingData()
    CloseAllMenus()
end

local stopNextSpawn = false
function StopSelling(houseID)
    houses[houseID].selling = false
    isSellingAHouse = false
    stopNextSpawn = true

    if clientPed then 
        DeleteEntity(clientPed)
    end
    
    SaveHousingData()
    CloseAllMenus()
end

function RentHouse(houseID)
    if housesOwn > 1 then 
        houses[houseID].renting = true

        SaveHousingData()
        CloseAllMenus()
    else 
        TriggerEvent("notification:send", {color = "yellow", time = 5000, text = "You need at least 2 houses to rent one."})
    end
    
end

function StopRenting(houseID)
    houses[houseID].renting = false

    SaveHousingData()
    CloseAllMenus()
end

function RespondOffer(houseID, accept)
    if offeredPrice then 
        if accept then
            houses[houseID].bought = false
            houses[houseID].owner = nil
            houses[houseID].selling = false
            isSellingAHouse = false
            TriggerEvent("bank:changeBank", offeredPrice)
            TriggerEvent("notification:send", {color = "green", time = 5000, text = "You sold the house for $"..offeredPrice})
        else
            SearchForClients(houseID)
            TriggerEvent("notification:send", {color = "blue", time = 5000, text = "The buyer left."})
        end

        if clientPed then 
            DeleteEntity(clientPed)    
        end

        clientPed = nil
        offeredPrice = nil

        SaveHousingData()
        CloseAllMenus()
    end
end


function LoadItems(items)
    CloseAllMenus(1, true)

    local options = {
        {id="HOUSE_INV_BACK", label = "Back", cb = function() CloseAllMenus() end},  
        --{id = "BLANK", label = "---------------//---------------"},
        {id="HOUSE_INV_TITLE", label = "---[House Inv]"},  
    }

    for _, item in pairs(items) do 
        table.insert(options, {id = item.id, label = item.label, quantity = item.quantity, cb = function() SendItemToPlayer(items, i) end})
    end

    --table.insert(options, {id = "BLANK", label = "---------------//---------------"})
    table.insert(options, {id = "PLAYER_INV_TITLE", label = "---[Pockets]"})
    local pItems = json.decode(GetExternalKvpString("save-load", "INV_ITEMS"))
    for i, item in pairs(pItems) do 
        table.insert(options, {id = item.id, label = item.label, quantity = item.quantity, cb = function() SendItemToHouseInv(pItems, i) end})
    end

    TriggerEvent("side-menu:addOptions", options)
    TriggerEvent("save-load:setGlobalVariables", {{name = "CAN_OPEN_POCKETS", type = "int", value = 1}, {name = "IN_HOUSE_INV", type = "int", value = 1}}) 
end

function SendItemToHouseInv(items, itemID)
    local item = table.remove(items, itemID)

    table.insert(closestHouse.inventory, item)

    SaveHousingData()
    CloseAllMenus(1, true)

    TriggerEvent("save-load:setGlobalVariables", {{name = "INV_ITEMS", type = "string", value = json.encode(items)}})

    LoadItems(closestHouse.inventory)
end

function SendItemToPlayer(items, itemID)
    local item = table.remove(items, itemID)
    closestHouse.inventory = items
    
    SaveHousingData()
    CloseAllMenus(1, true)

    TriggerEvent("inventory:addItems", {{id = item.id, label = item.label, quantity = item.quantity}})

    LoadItems(closestHouse.inventory)
end

function SaveHousingData()
    TriggerServerEvent("save-load:saveData", "./housing/houses.json", houses, true)
end

function CloseAllMenus(cooldown, stay)
    Citizen.CreateThread(function()   
        if cooldown then
            Citizen.Wait(cooldown)
        end

        if stay then

        else
            menuOpen = false
        end
    end)

    TriggerEvent("side-menu:resetOptions")
    TriggerEvent("save-load:setGlobalVariables", {{name = "CAN_OPEN_POCKETS", type = "int", value = 0}, {name = "IN_HOUSE_INV", type = "int", value = 0}}) 
end

Citizen.CreateThread(function()
    local incomePercentage = 0.02
    while true do 
        Citizen.Wait(600000)

        local income = 0
        for _, house in pairs(houses) do 
            if charID and house.owner == charID then
                if house.renting then 
                    income = income + math.floor(house.price * incomePercentage)
                end
            end
        end
        
        if income ~= 0 then 
            TriggerEvent("bank:changeBank", income)
            TriggerEvent("notification:send", {color = "green", time = 5000, text = "You received a total of $"..income.." from your renting houses."})
        end
    end
end)



function SearchForClients(houseID)
    Citizen.CreateThread(function()
        local currentSellingHouse = houses[houseID]
        local chanceOfSpawn = 30
        local searching = true
        clientPed = nil
        while searching do 
            Citizen.Wait(300000)

            if stopNextSpawn then 
                searching = false
            end

            if clientPed == nil and stopNextSpawn == false and math.random(0, 100) <= chanceOfSpawn then 
                clientPed = GetClientPed(currentSellingHouse)
            end

            if clientPed then 
                TriggerEvent("notification:send", {color = "yellow", time = 5000, text = "Someone is interested in your house. Go meet them!"})

                Citizen.Wait(300000)

                if clientPed then
                    DeleteEntity(clientPed)
                    clientPed = nil
                end

                TriggerEvent("notification:send", {color = "red", time = 5000, text = "Buyer Left. You took too long."})
                CloseAllMenus()
            end
            
        end

        stopNextSpawn = false
    end)
end

Citizen.CreateThread(function()
    while true do 
        Citizen.Wait(1)
        if clientPed then 
            local pPed = GetPlayerPed(-1)
            TaskSetBlockingOfNonTemporaryEvents(clientPed, true)
            --FreezeEntityPosition(clientPed, true)
            local heading = MakeEntityFaceEntity(clientPed, pPed)
            SetEntityHeading(clientPed, heading)
        end
    end
end)

function GetClientPed(currentSellingHouse)
    local model = clientModels[math.random(1, #clientModels)]
    local ped = nil
    
    if IsModelInCdimage(model) and IsModelValid(model) then
        RequestModel(model)
        while not HasModelLoaded(model) do 
            Citizen.Wait(1)
        end
        
        ped = CreatePed(26, GetHashKey(model), currentSellingHouse.coords.x, currentSellingHouse.coords.y, currentSellingHouse.coords.z, 0.0, true, true)
        SetEntityInvincible(ped, true)
        CloseAllMenus()
    end

    return ped
end

function MakeEntityFaceEntity(entity1, entity2)
    local p1 = GetEntityCoords(entity1, true)
    local p2 = GetEntityCoords(entity2, true)

    local dx = p2.x - p1.x
    local dy = p2.y - p1.y

    local heading = GetHeadingFromVector_2d(dx, dy)
    return heading
end

function StartVisit(price)
    CloseAllMenus(8000)
    
    DoScreenFadeOut(1000)
    TriggerEvent("notification:send", {color = "blue", time = 5000, text = "Buyer is looking through the house..."})
    Citizen.Wait(5000)
    DoScreenFadeIn(1000)
    Citizen.Wait(1000)
    EndVisit(price)
end

function EndVisit(price)
    local chanceToSell = 50
    if math.random(0, 100) <= chanceToSell then
        local priceRange = math.floor(price * 0.2) 
        offeredPrice = math.random(price - priceRange, price + priceRange)
        TriggerEvent("notification:send", {color = "blue", time = 5000, text = "The buyer has offered $"..offeredPrice.." for the house."})
    else
        offeredPrice = nil
        TriggerEvent("notification:send", {color = "red", time = 5000, text = "The buyer is not interested."})
    end
end

RegisterNetEvent("multichar:charIdChanged")
AddEventHandler("multichar:charIdChanged", function()
    charID = GetExternalKvpInt("save-load", "CHAR_ID")
end)

RegisterNetEvent("multichar:charDied")

function RemoveHousesFromChar()
    for houseID, house in pairs(houses) do
        if house.owner and charID and house.owner == charID then 
            houses[houseID].owner = nil
            houses[houseID].bought = false
            houses[houseID].selling = false
            houses[houseID].renting = false
            houses[houseID].blip = nil
        end
    end

    SaveHousingData()
    CloseAllMenus()
end
AddEventHandler("multichar:charDied", RemoveHousesFromChar)


--[[ RegisterCommand("givew", function(source, args, rawCommand)
    if args[1] and args[2] then 
        GiveWeaponToPed(GetPlayerPed(-1), GetHashKey(args[1]), tonumber(args[2]), false, true)
    end
end, false) ]]